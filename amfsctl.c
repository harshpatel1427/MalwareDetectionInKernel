/*
* This code will take various options from user
* and based on the option it will call appropriate
* ioctl inside kernel. New added ioctl are in header
* file new_ioctl_number.h. One can add, remove, list
* patterns from the pattern database inside the kernel
* using these options. Mount point should be /mnt/amfs/
* in which pattern database will reside.
*/

#include <asm/unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include "new_ioctl_number.h"

int main(int argc, char *argv[])
{
	int option, fd, error, rflag = 0, aflag = 0, lflag = 0;
	char optstring[] = "lar", *mount_point = NULL;
	char usage[] = "./amfsctl -l/a/r [\"pattern\"] mount_point(/mnt/amfs)";
	struct argument *args;

	args = (struct argument *) malloc(sizeof(struct argument));
	args->pattern = (char *) malloc(sizeof(char *));


	while ((option = getopt(argc, argv, optstring)) != (-1)) {
		switch (option) {

		case 'l':
			lflag++;
			break;

		case 'a':
			aflag++;
			break;

		case 'r':
			rflag++;
			break;

		case '?':
			printf("Invalid Character %c found\n", optopt);
			error = -1;
			goto out;

		}
	}

	/* Checking for valid options */
	if (lflag == 1) {
		if (aflag != 0 || rflag != 0) {
			printf("Error in command usage. Usage is %s\n", usage);
			error = -1;
			goto out;
		} else {
			if (optind + 1 == argc)
				mount_point = argv[optind];
			else {
				printf("Error in command usage. Usage is %s\n", usage);
				error = -1;
				goto out;
			}
		}
	} else if (((aflag == 0 && rflag == 1) || (aflag == 1 && rflag == 0))
						&& optind < argc && optind+2 == argc) {
		args = (struct argument *) malloc(sizeof(struct argument));
		args->pattern = (char *) malloc(sizeof(char *));
		args->pattern = strdup(argv[optind]);
		args->length = strlen(args->pattern);
		optind++;
		mount_point = argv[optind];
	} else {
		printf("Error in command usage. Usage is %s\n", usage);
		error = -1;
		goto out;
	}

	/* Checking for valid mount point */
	if (strcmp(mount_point, "/mnt/amfs") != 0) {
		if (strcmp(mount_point, "/mnt/amfs/") != 0) {
			printf("Invalid Mount Point\n");
			error = -1;
			goto out;
		}
	}

	/* Opening pattern.db file for reading/modifying */
	fd = open("/mnt/amfs/", O_RDONLY);
	if (fd == -1) {
		printf("Error in opening file\n");
		error = -1;
		goto out;
	}

	/* Calling appropriate ioctl methods here */
	if (lflag == 1) {

		args = (struct argument *) malloc(sizeof(struct argument));

		/* getting length of the patterns to print */
		error = ioctl(fd, IOCTL_PATTERN_LENGTH_COUNT, &(args->length));
		if (error == -1) {
			printf("Error in calling ioctl\n");
			perror("Error:");
			goto close;
		}
		if (args->length != 0) {

			args->pattern = (char *) malloc(sizeof(char) * args->length);

			/* Calling ioctl for receiving patterns list */
			error = ioctl(fd, IOCTL_PATTERN_READ, args);
			if (error == -1) {
				printf("Error in calling ioctl\n");
				perror("Error:");
				goto close;
			}
			printf("List of patterns are\n%s\n", args->pattern);
		} else
			printf("No patterns to show\n");

	} else if (aflag == 1) {
		if (args->length == 0) {
			printf("Pattern can't be empty!\n");
			error = -1;
			goto close;
		}

		if (args->length > 256) {
			printf("Patterns can't be more than 256 characters\n");
			error = -1;
			goto close;
		}

		/* Calling ioctl to add pattern in pattern databasse */
		error = ioctl(fd, IOCTL_PATTERN_ADD, args);
		if (error == -1) {
			printf("Error in calling ioctl. Pattern may alreaady exists!\n");
			perror("Error:");
			goto close;
		}
	} else {
		if (args->length == 0) {
			printf("Pattern can't be empty!\n");
			error = -1;
			goto close;
		}

		/* Calling ioctl to remove patterns from pattern database */
		error = ioctl(fd, IOCTL_PATTERN_REMOVE, args);
		if (error != 0) {
			printf("Error in calling remove pattern function.Pattern may not exists!\n");
			perror("Error:");
			goto close;
		}
	}
close:
	close(fd);
out:
	free(args->pattern);
	free(args);
	return error;
}
